
<html>
<head><title>OBR Server</title></head>
<link rel="stylesheet" href="/doc/styles.css"></link>
<body>

<h1>OBR Server</h1>

The Bundle Server provides HTTP-based services to support application deployment 
through Launcher and Oscar Bundle Repository (OBR). It also provides access
to bundle documentation. These services are provided by default on port 9999.

<h2>Quick Start</h2>
There is no quick start. Installing the OBR Server is a little complicated, but
the process is described in detail below.


<h2>OBR XML Service </h2>

The context path <code>/bundle</code> returns dynamically-generated content that describes 
every bundle jarfile in the bundle/ build subtree. Any Oscar runtime can use 
this feature to install bundles that are in the Gemini source tree. You just need 
to have the Bundle Repository installed (this is standard unless you turn it off ) 
and use the obr urls command to point your Oscar at the repository. 
<pre>
-> obr urls 
http://oscar-osgi.sf.net/repository.xml 
-> obr urls http://localhost:9999/bundle 
-> obr list 
Bundle Repository (1.1.2) 
Email Log Handler (0.1.0) 
EPICS Service (0.0.1) 
... 
-> obr install "EPICS Service" 
Installing: EPICS Service 
-> 
</pre>

<h2>Buncle Documentation Service</h2>

A servlet on <code>http://<host>:9999/doc</code> gives a listing of the bundles
and their descriptions, which it generates by reading the manifest files
in realtime. If a bundle has a <code>doc/index.hml</code> file, this file
will be linked from the index page. It is considered good form to document
your bundles.

<h2>Application Deployment Service </h2>
The Bundle Server also provides facilities for downloading application defini- 
tions; this is the server-side support for Launcher. Config files under <code>app/</code> are 
run through the <a href="http://jakarta.apache.org/velocity/docs/">Velocity</a> 
template engine before being returned. Ok, so in order for Velocity to be useful, 
there need to be objects bound to 
Velocity identifiers. The Bundle Server defines the following useful bindings: 

<dl>
<dt><code>obr.root()</code></dt>
<dd>Expands to the URL for the OBR XML file where the Bundle Server is running.</dd>
<dt><code>obr.urls(["Bundle", ... )]</code></dt>
<dd>Expands a list of bundle names to a list of URLs 
for the corresponding bundles. This way you don't have to change URLs 
if the bundles move around.</dd>
<dt><code>param</code></dt>
<dd>Expands to the value of param on the HTTP request; so if the URL used 
when requesting the file includes <code>...&foo=bar</code> then <code>$foo</code> will expand to 
bar. The Launcher uses this feature when requesting <code>logging.properties</code>, 
passing the desired log directory as <code>logdir</code>. 
</dd>
</dl>


<h2>Bundle Launcher Access </h2>
The Bundle Server provides unmodified access to the <code>bundle/</code> and 
<code>runtime/</code> trees; the former for OBR and the latter so you can download the launcher: 
<pre>
wget http://manjar:9999/runtime/launcher/launcher.jar 
</pre>



<h2>Bootstrapping the Bundle Server </h2>
The Bundle Server is itself a deployable application, but getting it to serve itself 
up is a bit of a chicken-and-egg problem. Here is how to set it up. 
<ol>
<li>I find that it's easiest to set up an alias for launcher that points to your 
dev tree: 
<pre>
alias launcher='java -jar ~/Projects/osgi/runtime/launcher/launcher.jar'
</pre>
<li>Fetch it from another machine and give it an alias. 
<pre>
launcher -h:manjar -i:bundle-server -a:temp 
</pre>
<li>Set the bundle property to point to your local repository (dev) root, and 
then start up the app. 
<pre>
launcher -a:temp -b:edu.gemini.util.obr.root=/Users/rnorris/Projects/osgi 
launcher -a:temp 
</pre>
If you type <code>ps -l</code> you will see that everything is running but it’s pointed 
to the other machine. 
<pre>
</pre>

<li>In another window, install the app again, this time from your own running 
server. You also need to set the <code>root</code> property.
<pre>
launcher -i:bundle-server 
launcher -a:bundle-server -b:edu.gemini.util.obr.root=/Users/rnorris/Projects/osgi 
</pre>
Start up the server so it will download all its bundles. You will get a bind 
exception because the port is already bound in the other instance . This is 
ok. 
<pre>
launcher -a:bundle-server 
</pre>
<pre>
</pre>
<li>Shut down both servers now, by typing <code>shutdown</code> at both <code>-&gt;</code> prompts. 
<pre>
</pre>
<li>Uninstall the temp version, and start up the new one. 
<pre>
launcher -a:temp -u 
launcher -a:bundle-server 
</pre>
<li>If you do a <code>ps -l</code> you will see that it's pointed at itself now. Note that this 
means you can't update the OBR Service itself. If this is going to be a 
problem, you can fix this by pointing it at the filesystem location rather 
than the HTTP location, then turning auto-start down to level 3. 
<pre>
-&gt; uninstall &lt;number for OBR Service&gt; 
-&gt; install file:/Users/rnorris/Projects/osgi/bundle/util/obr-server/obr-server.jar 
-&gt; start &lt;number for new OBR Service&gt; 
-&gt; shutdown 

launcher -a:bundle-server -L:3 
launcher -a:bundle-server 
</pre>
If you do <code>ps -l</code> now, everything should look correct. 
<pre>
</pre>
<li>You should now be able to hit your dev repository from any instance of 
Oscar as follows: 
<pre>
-> obr urls http://localhost:9999/bundle 
-> obr list 
</pre>

</ol>

<h2>Provided Services</h2>

None.

<h2>Service Dependencies</h2>

This bundle depends on:
<ul>
<li>Servlet
<li>HTTP Service
</ul>

<h2>Configuration</h2>

<h3>System Properties</h3>

None.

<h3>Bundle Properties</h3>

<dl>
<dt><code>org.osgi.service.http.port</code></dt>
<dd>The HTTP port to run the service on. Defaults to <code>9999</code> in the 
Bundle Server application.</dd>
<dt><code>edu.gemini.util.obr.root</code></dt>
<dd>Path to the root of the dev tree. Normally an absolute path. Everything will
get served directly out of this tree, so if you do a build and then an update in 
Oscar, you will get the latest stuff.</dd>
<dt><code>oscar.repository.url</code></dt>
<dd>If you want to have Oscar automatically look at your OBR repository
rather than the one at SourceForge (and normally this is the case), you 
need to set this to point to your machine with a value like <code>http\://manjar\:9999/bundle</code>
</dd>
</dl>

<h3>Logging Properties</h3>

None.

<h3>Policy</h3>

None.

</body>
</html>